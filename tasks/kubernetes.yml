---
- name: Installing helm
  become: true
  shell: |
    curl https://get.helm.sh/helm-v3.3.1-linux-amd64.tar.gz \
        -s --output helm-v3.3.1-linux-amd64.tar.gz
    tar zxf helm-v3.3.1-linux-amd64.tar.gz linux-amd64/helm
    mv linux-amd64/helm /usr/local/bin
    chmod +x /usr/local/bin/helm
  args:
    chdir: '{{ tmp_dir }}'
  when:
    - use_kubernetes
- name: Installing kubectl
  become: true
  shell: |
    api=https://storage.googleapis.com/kubernetes-release/release
    curl -LO $api/$(curl -s $api/stable.txt)/bin/linux/amd64/kubectl
    chmod +x ./kubectl
    mv ./kubectl /usr/local/bin/kubectl
  args:
    chdir: '{{ tmp_dir }}'
  when:
    - use_kubernetes
- name: Installing pyhelm
  become: "{{ not lookup('env','VIRTUAL_ENV') }}"
  pip:
    name: pyhelm
  register: my_result
  until: my_result is succeeded
  retries: 5
  delay: 10
  when:
    - use_kubernetes
- name: Installing grpcio
  become: "{{ not lookup('env','VIRTUAL_ENV') }}"
  pip:
    name: grpcio
  register: my_result
  until: my_result is succeeded
  retries: 5
  delay: 10
  when:
    - use_kubernetes
- name: Installing openshift
  become: "{{ not lookup('env','VIRTUAL_ENV') }}"
  pip:
    name: openshift
  register: my_result
  until: my_result is succeeded
  retries: 5
  delay: 10
  when:
    - use_kubernetes
- name: Creating configmap
  community.kubernetes.k8s:
    name: xtesting
    api_version: v1
    kind: ConfigMap
    namespace: default
    state: present
  when:
    - use_kubernetes
    - not use_artifacts
- name: Updating configmap according to volumes
  shell:
    cmd: |
      kubectl create configmap xtesting --from-file={{ item.split(':').0 }} \
        --dry-run -o yaml | kubectl apply -f -
  with_items: '{{ docker_args.volumes }}'
  when:
    - use_kubernetes
    - not use_artifacts
